name: New Build

on:
  pull_request:
    branches: ["*"]

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - uses: actions/checkout@v4

      - name: Setup Nodejs
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

  test:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    defaults:
      run:
        working-directory: web

    steps:
      - uses: actions/checkout@v4

      - name: Setup Nodejs
        uses: actions/setup-node@v4

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Test Coverage
        run: pnpm test:coverage

      - name: Add test results to PR
        uses: VeryGoodOpenSource/very_good_coverage@v2
        with:
          path: "web/coverage/lcov.info"
          min_coverage: 0
      - name: ⚙️ Generating coverage badges
        uses: jpb06/coverage-badges-action@latest
        with:
          coverage-path: coverage/coverage-summary.json
          badges-icon: vitest
          badges-style: flat
          badges-color: green
          badges-text: coverage
          badges-path: coverage/badges.svg
      # - name: Create Coverage Badges
      #   uses: jaywcjlove/coverage-badges-cli@main
      #   with:
      #     style: flat
      #     source: web/coverage/coverage-summary.json
      #     output: web/coverage/badges.svg
      #     jsonPath: totals.percent_covered

      # - name: Upload Coverage Badge Artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: coverage-badge
      #     path: web/coverage/badges.svg

      # - name: Comment on PR with Artifact Note
      #   uses: peter-evans/create-or-update-comment@v3
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     issue-number: ${{ github.event.pull_request.number }}
      #     body: |
      #       ## 🧪 Test Coverage Badge

      #       A coverage badge has been generated and is available in the workflow artifacts:
      #       👉 [Download Coverage Badge from Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      #       You can preview the badge by downloading `badges.svg` from the **"Artifacts"** section of the workflow run.
      #     edit-mode: replace
